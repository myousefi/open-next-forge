---
title: Feature Flags
description: Control access to features in your application.
---

Feature flags (also known as feature toggles) allow you to control access to specific features in your application. next-forge provides a simple but powerful feature flag system that can be used to:

- Roll out features gradually to users
- A/B test new functionality
- Enable/disable features based on user segments
- Control access to beta or experimental features

## How it works

next-forge stores flag definitions in a Cloudflare Worker backed by KV or Durable Objects. The Worker exposes a simple REST API that the `@repo/feature-flags` package calls to evaluate flag values for the current user. You can reuse this package across any workspace in the repo – each app simply needs to point at the same Worker URL and share API tokens.

We've created an intelligent helper called `createFlag` that wires your flag into Clerk authentication, retrieves the decision from Cloudflare, and exposes metadata for the inspector toolbar. Configure the Worker credentials with:

- `FLAGS_SERVICE_URL` – the base URL of your Cloudflare Worker that exposes `/evaluate` and `/definitions` endpoints
- `FLAGS_SERVICE_EVALUATION_TOKEN` – bearer token used by server components to resolve a user's flags
- `FLAGS_SERVICE_ADMIN_TOKEN` – bearer token the toolbar route uses to read flag definitions
- `FLAGS_SECRET` – shared secret protecting the `/.well-known/feature-flags` route
- `NEXT_PUBLIC_FLAGS_TOOLBAR_SCRIPT_URL` – the URL to the Cloudflare-hosted inspector script that renders the toolbar in the browser

<Tip>
  For `FLAGS_SECRET`, you can run `node -e "console.log(crypto.randomBytes(32).toString('base64url'))"` or `openssl rand -base64 32` in your terminal to generate a random value. Use a separate secret for `FLAGS_SERVICE_EVALUATION_TOKEN` and `FLAGS_SERVICE_ADMIN_TOKEN` so you can rotate them independently.
</Tip>

## Adding a new flag

To add a new flag, register it in your Cloudflare data store (for example, by writing it into KV) and then modify the feature flags index file. Let's add a new flag called `showAnalyticsFeature` with a helpful description so it shows up clearly in the inspector:

```ts title="packages/feature-flags/index.ts {4}"
import { createFlag } from './lib/create-flag';

export const showBetaFeature = createFlag('showBetaFeature');
export const showAnalyticsFeature = createFlag('showAnalyticsFeature', {
  description: 'Surfaced Cloudflare Web Analytics dashboards to customers.',
});
```

Make sure the key you use here matches the key stored in Cloudflare exactly.

## Usage in your application

To use the flag in your application, simply import it from the `@repo/feature-flags` package and use it like a normal boolean value.

```tsx title="page.tsx"
import { showAnalyticsFeature } from '@repo/feature-flags';
import { notFound } from 'next/navigation';

export default async function Page() {
  const isEnabled = await showAnalyticsFeature();

  if (!isEnabled) {
    notFound();
  }

  return <div>Analytics feature is enabled</div>;
}
```

Because feature flags are tied to the user, they only work if the user is signed in. Otherwise, the flag will always return `false`.

## Overriding flags in development

You can override flags in development by using the Cloudflare feature flag inspector. Host the inspector UI in a Worker, point `NEXT_PUBLIC_FLAGS_TOOLBAR_SCRIPT_URL` at its script bundle, and click the "Flags" icon to toggle values locally. The inspector talks to the same `/.well-known/feature-flags` endpoint secured by `FLAGS_SECRET`, so overrides stay private to your environment.